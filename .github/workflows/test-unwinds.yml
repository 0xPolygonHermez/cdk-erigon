name: Unwinds tests
on:
  push:
    branches:
      - fixing-unwids-tests
  workflow_dispatch:

jobs:
  fixing-unwids-tests:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout cdk-erigon
        uses: actions/checkout@v4
        with:
          path: cdk-erigon

      - uses: actions/setup-go@v4
        with:
          go-version: '1.19'

      - name: Build
        run: |
          cd ./cdk-erigon
          make cdk-erigon

      - name: Update cdk-erigon-lib
        run: |
          erigonPath=$(pwd)
          cd /root/go/pkg/mod/github.com/gateway-fm
          cd $(ls ./ | grep cdk-erigon-lib | tail -1)
          cd ./kv
          chmod +x "$erigonPath/cdk-erigon/zk/tests/unwinds/modify-cdk-erigon-lib.sh"
          "$erigonPath/cdk-erigon/zk/tests/unwinds/modify-cdk-erigon-lib.sh"
          cat ./tables.go

      - name: Build2
        run: |
          cd ./cdk-erigon
          make cdk-erigon

      - name: Prepare configs
        run: |
          cd ./cdk-erigon
          mkdir ./.dynamic-configs
          cd ./.dynamic-configs
          cp ../zk/tests/unwinds/config/dynamic-integration8.yaml ./
          cp ../zk/tests/unwinds/config/dynamic-integration-allocs.json ./
          cp ../zk/tests/unwinds/config/dynamic-integration-chainspec.json ./
          cp ../zk/tests/unwinds/config/dynamic-integration-conf.json ./
          ls -la

      - name: Run tests
        run: |
          chmod +x ./cdk-erigon/zk/tests/unwinds/unwind.sh
          ./cdk-erigon/zk/tests/unwinds/unwind.sh

  
